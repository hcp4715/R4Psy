---
title: "Experiment 2"
output: pdf_document
---

# General preparations

## Load libraries
```{r,message=FALSE}
library(mousetrap)
library(ggplot2)
library(dplyr)
library(tidyr)
library(afex)
library(MBESS)
library(ordinal)
```

## Custom ggplot2 theme
```{r}
theme_set(theme_classic()+ 
  theme(
    axis.line = element_line(colour = "black"),
    axis.ticks = element_line(colour = "black"),
    axis.text = element_text(colour = "black"),
    panel.border = element_rect(colour = "black", fill=NA)
  ))
```

## Custom functions
```{r}
# Function to compute confidence interval for partial eta-squared
get_partial_etas <- function(anova_table, conf.level=.90){
  partial_etas <- sapply(row.names(anova_table),function(i){
    F <- anova_table[i,"F"]
    df1 <- anova_table[i,"num Df"]
    df2 <- anova_table[i,"den Df"]
    ci <- conf.limits.ncf(F.value=F,conf.level=conf.level,df.1=df1,df.2=df2)
    return(
      c(pes=((F*df1)/(F*df1+df2)),
        lower=ci$Lower.Limit/(ci$Lower.Limit+df1+df2+1),
        upper=ci$Upper.Limit/(ci$Upper.Limit+df1+df2+1)))
  })
  return(t(partial_etas))
}
```


## Data import
```{r}
raw_data <- read.csv("../data/exp2.csv")
raw_data$Typicality <- factor(raw_data$Condition,levels=c("Typical","Atypical"))
raw_data$group <- factor(raw_data$group,levels=c("default","slow"))
```

# Correctness

## Percent of correct trials per condition
```{r}
with(raw_data,table(group, correct)/c(table(group)))
```

## Chi-squared test
```{r}
chisq.test(with(raw_data,table(group, correct)),correct = FALSE)
```

## Generalized linear mixed model
```{r}
contrasts(raw_data$group) <- c(0.5,-0.5)
summary(glmer(correct~(1|subject_nr)+group,family="binomial",data=raw_data))
```

## Exclude incorrect trials
```{r}
raw_data <- subset(raw_data, correct==1)
```


# Trajectory preprocessing
```{r}
mt_data <- mt_import_mousetrap(raw_data)
mt_data <- mt_remap_symmetric(mt_data)

# Start position descriptives (xpos)
mean(mt_data$trajectories[,1,"xpos"])
sd(mt_data$trajectories[,1,"xpos"])

# Start position descriptives (ypos)
mean(mt_data$trajectories[,1,"ypos"])+1050/2
sd(mt_data$trajectories[,1,"ypos"])

mt_data <- mt_align_start(mt_data, start=c(0,0))
mt_data <- mt_derivatives(mt_data)
mt_data <- mt_measures(mt_data)
mt_data <- mt_time_normalize(mt_data)
```

# Manipulation check: maximum velocity and acceleration

## Aggregate data per participant and condition
```{r}
agg_vel_acc <- mt_aggregate_per_subject(mt_data, use_variables=c("vel_max","acc_max"), 
  use2_variables="group", subject_id="subject_nr")
```

## Descriptives
```{r}
mean_vel_acc <- agg_vel_acc %>%
  group_by(group) %>%
  summarize(
    N = n(),
    M_vel = mean(vel_max),
    SD_vel = sd(vel_max),
    M_acc = mean(acc_max),
    SD_acc = sd(acc_max)
    ) %>%
  as.data.frame()

print(mean_vel_acc, digits=2)
```


## Compare maximum velocity
```{r}
# Between groups t-test
vel_t <- t.test(vel_max~group, data=agg_vel_acc, paired=FALSE,var.equal=TRUE)
vel_t

# Cohen's d including 95 % CI
ci.smd(ncp = vel_t$statistic[[1]],n.1 = mean_vel_acc$N[1],n.2 = mean_vel_acc$N[2], conf.level = .95)
```

## Compare maximum acceleration
```{r}
# Between groups t-test
acc_t <- t.test(acc_max~group, data=agg_vel_acc, paired=FALSE,var.equal=TRUE)
acc_t

# Cohen's d including 95 % CI
ci.smd(ncp = acc_t$statistic[[1]],n.1 = mean_vel_acc$N[1],n.2 = mean_vel_acc$N[2], conf.level = .95)
```


# Aggregate trajectory curvature

## Average time-normalized tajectories
```{r,fig.height=2.7, fig.width=4.5}
mt_plot_aggregate(mt_data, use = "tn_trajectories", facet_col = "group",
  x = "xpos", y = "ypos", color = "Typicality", subject_id = "subject_nr")+
  xlab("x coordinate (px)") + ylab("y coordinate (px)")+
  scale_color_manual(values = c("black","grey60"))
```

## Comparison of MAD aggregated per participant

### Aggregate data per participant and condition
```{r}
agg_mad <- mt_aggregate_per_subject(mt_data, subject_id = "subject_nr",
  use_variables = "MAD", use2_variables = c("Typicality","group"))
```

### Descriptives and paired t-tests 
```{r,message=FALSE}
mad_table <- agg_mad %>%
  group_by(group) %>%
  select(MAD,group,Typicality) %>%
  summarize(
    N =  length(MAD[Typicality=="Typical"]),
    M_t = mean(MAD[Typicality=="Typical"]),
    SD_t = sd(MAD[Typicality=="Typical"]),
    M_a = mean(MAD[Typicality=="Atypical"]),
    SD_a = sd(MAD[Typicality=="Atypical"]),
    t = t.test(MAD[Typicality=="Atypical"],MAD[Typicality=="Typical"],paired=TRUE)$statistic,
    p = t.test(MAD[Typicality=="Atypical"],MAD[Typicality=="Typical"],paired=TRUE)$p.value,
    d = (M_a-M_t)/sd(MAD[Typicality=="Atypical"]-MAD[Typicality=="Typical"])
    )

mad_table %>%
  as.data.frame() %>%
  print(digits=3)
```

### Figure
```{r,fig.height=3.2, fig.width=4}
ggplot(agg_mad,aes(x=Typicality,y=MAD,linetype=group,group=group))+
  geom_line(stat="summary",fun.y="mean")+
  geom_point(stat="summary",fun.y="mean")+
  geom_errorbar(stat="summary",fun.data="mean_se",width=.2,linetype=1)+
  scale_linetype_manual(values=c(1,2))+
  coord_cartesian(ylim=c(0,400))
```


### ANOVA
```{r}
anova_mad <- aov_ez(data=agg_mad, dv = "MAD", between = "group", within = "Typicality",
                    id = "subject_nr")
nice(anova_mad,es = c("pes","ges"))

# 90 % confidence interval for partial eta-squared
round(get_partial_etas(anova_mad$anova_table, conf.level=.90),2)
```


# Distribution of trajectory shapes

## Bimodality coefficient
```{r}
# Standardize MAD per participant
mt_data <- mt_standardize(mt_data, use_variables = "MAD", within = "subject_nr")

# Calculate bimodality coefficient
mt_check_bimodality(mt_data, use_variables = "z_MAD",
  grouping_variables = c("group","Typicality"), methods = "BC")
```


## Smoothed heatmaps
```{r,fig.height=2, fig.width=6}
heatmap_smoothed <- mt_heatmap_ggplot(mt_data,
  xres = 1000,
  smooth_radius = 20,
  n_shades = 10,
  mean_image = 0.2,
  colors=c("white","black"),
  facet_col="group")
heatmap_smoothed+
  theme(strip.background = element_rect(colour = NA))
```


## Prototype classification

### Plot prototypes
```{r,fig.height=1.5}
mt_plot(mt_prototypes,facet_col="mt_id",only_ggplot = TRUE)+
  geom_path()+
  facet_grid(cols = vars(factor(mt_id,levels=rownames(mt_prototypes))))+
  theme(axis.text=ggplot2::element_blank(),axis.ticks=ggplot2::element_blank()) 
```

### Map trajectories onto prototypes
```{r}
mt_data <- mt_spatialize(mt_data)
mt_data <- mt_map(mt_data,prototypes = mt_prototypes,
  save_as = "measures", grouping_variables = "group")
mt_data$data$prototype_label <- mt_data$measures$prototype_label
```

### Classified trajectories per group

#### Relative frequencies
```{r,fig.height=2.5}
prototype_percentages <- mt_data$data %>%
  group_by(group,prototype_label) %>%
  summarise(n=n()) %>%
  mutate(Percent=paste(round(100*n/sum(n)),"%",sep=""))

mt_plot(mt_data, use = "sp_trajectories",
  x = "xpos", y = "ypos", facet_col = "prototype_label", facet_row="group",alpha=.2)+
  xlab("x coordinate (px)") + ylab("y coordinate (px)")+
  geom_text(data=prototype_percentages,aes(label=Percent),x=650,y=50)+
  scale_y_continuous(breaks=c(0,500,1000))+
  coord_cartesian(xlim=c(-900,900))
```

#### Chi-squared test
```{r}
chisq.test(with(mt_data$data,table(group, prototype_label)))
```


### Classified trajectories per group X typicality condition

#### Relative frequencies
```{r,fig.height=3.2, fig.width=4}
rel_freq_agg <- mt_data$data %>%
  group_by(group,Typicality,prototype_label) %>%
  summarise(n=n()) %>%
  mutate(Percent=n/sum(n))

spread(rel_freq_agg[,-4],"prototype_label","Percent",fill = 0) %>%
  as.data.frame()%>%
  print(digits=2)

ggplot(rel_freq_agg,aes(x=Typicality,y=Percent,fill=forcats::fct_rev(prototype_label)))+
  geom_bar(stat="identity",color="black")+
  scale_fill_brewer(type="seq",name="Classification")+
  facet_grid(.~group)
```

#### Ordinal mixed regression
```{r}
contrasts(mt_data$data$Typicality) <- c(-0.5,0.5)
contrasts(mt_data$data$group) <- c(0.5,-0.5)
summary(clmm(prototype_label~Typicality*group+(1|subject_nr),data=mt_data$data))
```
